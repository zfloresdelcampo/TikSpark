<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- AGREGA ESTA LÃNEA MAGICA -->
    <meta name="referrer" content="no-referrer">
    <title>Media Overlay</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: transparent; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        #media-container {
            max-width: 100%;
            max-height: 100%;
            display: none; 
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #media-container.show { opacity: 1; }

        img, video {
            max-width: 100%;
            max-height: 100vh;
            object-fit: contain;
            /* Sombra suave para que resalte */
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); 
        }
    </style>
</head>
<body>

    <div id="media-container"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        var firebaseConfig = {
            databaseURL: "https://flutter-ai-playground-bc58f-default-rtdb.firebaseio.com/"
        };
        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Error Firebase:", e); }

        const dbRef = firebase.database().ref('widgets/mediaOverlay');
        const container = document.getElementById('media-container');

        console.log("âœ… Media Overlay cargado y esperando...");

        dbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            console.log("ðŸ“© Datos recibidos:", data);
            
            if (!data || !data.url) return;

            // Calculamos hace cuÃ¡nto se enviÃ³ el comando
            const timeDiff = Date.now() - data.timestamp;

            // Aumentamos el margen a 15 segundos por si acaso, para pruebas
            if (timeDiff < 15000) { 
                showMedia(data);
            } else {
                console.log("âš ï¸ El evento es antiguo (hace " + (timeDiff/1000) + "s). Ignorando.");
            }
        });

        function showMedia(data) {
            console.log("â–¶ï¸ Mostrando:", data.url);
            container.innerHTML = ''; 
            
            // Limpieza de clases para reiniciar animaciÃ³n
            container.className = '';
            void container.offsetWidth; // Forzar reflow

            let element;
            const isVideo = data.url.includes('.mp4') || data.url.includes('.webm');

            if (isVideo) {
                element = document.createElement('video');
                element.src = data.url;
                element.autoplay = true;
                element.volume = (data.volume || 100) / 100;
                
                // Importante: A veces los navegadores bloquean el audio si no hay click.
                // Intentamos reproducir con sonido:
                element.play().catch(e => {
                    console.warn("Autoplay bloqueado, intentando muteado:", e);
                    element.muted = true;
                    element.play();
                });

                element.onended = () => hideMedia(); 
            } else {
                element = document.createElement('img');
                element.src = data.url;
            }

            container.appendChild(element);
            container.style.display = 'block';
            
            setTimeout(() => container.classList.add('show'), 50);

            // Si es imagen, usar el timer. Si es video, esperamos al onended.
            if (!isVideo) {
                const duration = (data.duration || 5) * 1000;
                setTimeout(hideMedia, duration);
            }
        }

        function hideMedia() {
            console.log("â¹ï¸ Ocultando media");
            container.classList.remove('show');
            setTimeout(() => {
                container.style.display = 'none';
                container.innerHTML = '';
            }, 500);
        }
    </script>
</body>
</html>