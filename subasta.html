<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subasta Overlay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            font-family: Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Contenedor principal */
        .auction-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Estilo para el cuadro del temporizador */
        .timer-box {
            background-color: #000;
            color: #fff;
            padding: 15px 30px;
            border-radius: 12px;
            text-align: center;
            font-size: 5em;
            font-weight: bold;
            width: 350px;
            box-sizing: border-box;
            align-self: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            font-family: "Luckiest Guy";
        }

        /* Contenedor de participantes */
        .participants-container {
            background-color: #1d1c1c;
            border-radius: 12px;
            padding: 15px;
            width: 350px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            box-sizing: border-box;
        }

        .participants-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Estilo base para cada fila de participante */
        .participant-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.1); 
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            margin-right: 15px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }

        .medal-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .default-avatar-icon {
            background-color: #0000009f; 
            box-shadow: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 448 512'%3E%3Cpath fill='%23cccccc' d='M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm89.6 32h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.7-5.8-72.9-16h-16.7C60.2 288 0 348.2 0 448v48c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32v-48c0-99.8-60.2-160-134.4-160z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 50%;
        }

        .info-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
            min-width: 0;
        }

        .text-bar.name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .text-bar {
            height: auto;
            width: auto;
            border-radius: 6px;
            color: #fff;
            font-weight: bold;
            background-color: transparent !important;
        }

        .participant-row.gold { background-color: #483618; border-color: #aa8c34; }
        .gold .text-bar { color: #ffffff; font-weight: bold; }
        
        .participant-row.silver { background-color: #414040; border-color: #8a8a8a; }
        .silver .text-bar { color: #ffffff; font-weight: bold; }

        .participant-row.bronze { background-color: #492d1a; border-color: #a25f2b; }
        .bronze .text-bar { color: #ffffff; font-weight: bold; }

        .timer-box.snipe-mode {
            background-color: #ff000d;
            animation: blink-animation 1s infinite;
            text-shadow: 0 0 15px rgba(0, 0, 0, 7);
        }

        @keyframes blink-animation {
            0%   { background-color: #ff000d; }
            50%  { background-color: #850d13; }
            100% { background-color: #ff000d; }
        }

        .bid-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .coin-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-image: url('images/coin-icon.png');
            background-size: contain;
            background-repeat: no-repeat;
        }

        /* --- ESTILOS CORREGIDOS PARA LA PANTALLA DEL GANADOR --- */

        #winner-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: flex-start; 
            align-items: center;
            padding-left: calc(50vw - 175px - 180px);
            box-sizing: border-box;
        }

        /* Nueva regla para permitir m칰ltiples ganadores en fila */
        #winners-wrapper {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        /* Ajuste para m칰ltiples fotos */
        .winner-pfps-group {
            display: flex;
            gap: -10px; /* Ligero solapamiento para ahorrar espacio */
        }
        .winner-pfp.small {
            width: 60px; height: 60px; /* Un poco m치s peque침as si hay empate */
            margin-left: -15px;
            border-width: 3px;
        }
        .winner-pfp.small:first-child { margin-left: 0; }

        /* Ajuste para m칰ltiples nombres */
        .winner-names-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .winner-card {
            display: flex;
            align-items: center;
            gap: 20px;
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            transform: scale(0.9);
            opacity: 0;
            animation: pop-in 0.5s forwards ease-out;

            /* A칌ADE ESTO: */
            width: 525px; /* Ajusta este n칰mero seg칰n qu칠 tan ancho quieras el cartel */
            box-sizing: border-box; /* Para que el padding no sume al ancho */
        }

        .winner-pfp {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid #FFD700;
            background-size: cover;
            background-position: center;
        }

        .winner-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            color: white;
            min-width: 0;
        }

        .ganador-text {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
        }

        .winner-name {
            font-size: 1.4em;
            font-weight: bold;
            width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Ancho cuando son exactamente 2 en empate */
        .winner-name.empate-2 {
            width: 180px;
        }

        /* Ancho cuando son exactamente 3 en empate (M치s reducido) */
        .winner-name.empate-3 {
            width: 150px;
        }

        .winner-coins {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .winner-coin-icon {
            width: 20px;
            height: 20px;
        }

        #winner-coin-amount {
            font-size: 1.4em;
            font-weight: bold;
            color: #fce205;
        }

        .top1-badge {
            width: 120px;
            height: auto;
        }

        /* Estilo para los n칰meros del puesto 4 al 10 */
        .rank-number {
            width: 30px;
            margin-right: 10px;
            text-align: center;
            font-family: "Luckiest Guy";
            color: white;
            font-size: 2.5em; 
            flex-shrink: 0;
            -webkit-text-stroke: 1px rgba(0,0,0,0.5);
        }

        @keyframes pop-in {
            to { transform: scale(1); opacity: 1; }
        }

        /* --- ANIMACIONES DE PUESTOS --- */
        
        /* Animaci칩n original (VERDE + GRANDE) para subida de rango */
        @keyframes flashUp {
            0% { transform: scale(1); }
            50% { background-color: #2ecc71; transform: scale(1.05); box-shadow: 0 0 15px #2ecc71; border-color: #fff; }
            100% { transform: scale(1); }
        }

        /* Animaci칩n original (ROJO + PEQUE칌O) para bajada de rango */
        @keyframes flashDown {
            0% { transform: scale(1); }
            50% { background-color: #e74c3c; transform: scale(0.95); border-color: #c0392b; }
            100% { transform: scale(1); }
        }

        /* NUEVA ANIMACI칍N (SOLO GRANDE) para actualizaci칩n de moneda */
        @keyframes pulseOnly {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); } /* Solo escala, no cambia color */
            100% { transform: scale(1); }
        }

        .participant-row.rank-up { animation: flashUp 0.6s ease-out; z-index: 2; }
        .participant-row.rank-down { animation: flashDown 0.6s ease-out; z-index: 1; }
        .participant-row.pulse { animation: pulseOnly 0.3s ease-out; z-index: 2; }

    </style>
</head>
<body>

    <div id="winner-overlay">
        <div class="winner-card" id="winner-card-single">
            <!-- El contenido interno se generar치 din치micamente aqu칤 -->
        </div>
    </div>

    <div class="auction-container">
        <div class="timer-box">
            05:00
        </div>

        <div class="participants-container">
            <div class="participants-list">
                <!-- El contenido se genera din치micamente -->
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.js"></script>

    <script>
      const timerElement = document.querySelector('.timer-box');
      const participantsList = document.querySelector('.participants-list');
      const winnerOverlay = document.getElementById('winner-overlay');
      const winnerPfp = document.getElementById('winner-pfp');
      const winnerName = document.getElementById('winner-name');
      const winnerCoinAmount = document.getElementById('winner-coin-amount');

      const medalImages = { gold: 'images/primero.png', silver: 'images/segundo.png', bronze: 'images/tercero.png' };

      // --- CONFIGURACI칍N AUDIO ---
      const soundWin = new Audio('sounds/victory.mp3');
      const soundPop = new Audio('sounds/pop.mp3');
      const soundWhoosh = new Audio('sounds/whoosh.mp3'); 
      
      soundWin.volume = 0.5;
      soundPop.volume = 0.5;
      soundWhoosh.volume = 0.4;

      // --- RASTREADOR DE POSICIONES ANTERIORES (ARRAY DE 3) ---
      let lastTop3Ids = [null, null, null]; 
      
      // --- RASTREADOR DE MONEDAS (Objeto para recordar cuanto ten칤a c/u) ---
      let lastCoinsMap = {};

      function formatTime(seconds) {
        if (typeof seconds !== 'number' || seconds < 0) { seconds = 0; }
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
      }

      function createPlaceholderRow(medal) {
          return `<div class="participant-row ${medal}"><img class="medal-icon" src="${medalImages[medal]}"><div class="profile-icon default-avatar-icon"></div><div class="info-container"><div style="height: 12px; width: 150px; border-radius: 6px; background-color: rgba(255, 255, 255, 0.3);"></div><div style="height: 12px; width: 100px; border-radius: 6px; background-color: rgba(255, 255, 255, 0.3);"></div></div></div>`;
      }
      
      const socket = io();

      socket.on('init-data', (db) => { if (db && db.subasta) updateSubasta(db.subasta); });
      socket.on('widget-update', (msg) => { if (msg.widgetId === 'subasta') updateSubasta(msg.data); });

      function updateSubasta(data) {
            if (!data) return;

            // Temporizador (MODIFICADO)
            if (!data.isRunning && data.timeLeft <= 0 && !data.winnerInfo) {
                // Caso: Termin칩 todo (ni corre, ni hay ganador en pantalla, tiempo 0)
                timerElement.textContent = "游끠 FINALIZADO";
                timerElement.style.fontSize = "35px"; // Letra m치s peque침a para que quepa
                timerElement.style.color = "#FFFF00"; // <--- COLOR ROJO AQU칈
                timerElement.classList.remove('snipe-mode');
            } 
            else if (data.inSnipeMode) {
                // Caso: Modo Snipe (Segundos rojos)
                timerElement.textContent = data.timeLeft;
                timerElement.style.fontSize = "5em"; // Letra grande original
                timerElement.style.color = "#FFFFFF"; // Volver a blanco
                timerElement.classList.add('snipe-mode');
            } 
            else {
                // Caso: Normal (Reloj)
                timerElement.textContent = formatTime(data.timeLeft);
                timerElement.style.fontSize = "5em"; // Letra grande original
                timerElement.style.color = "#FFFFFF"; // Volver a blanco
                timerElement.classList.remove('snipe-mode');
            }

            // Procesar Participantes
            const participants = data.participants || {};
            const sortedParticipants = Object.values(participants).sort((a, b) => b.coins - a.coins);
            
            // --- NUEVO: LEER CANTIDAD DE FILAS CONFIGURADAS ---
            const maxRows = (data.config && data.config.rows) ? data.config.rows : 3;
            
            // --- DETECCI칍N DE CAMBIOS EN EL RANKING ---
            let orderChanged = false;
            let currentIds = [];

            for(let i = 0; i < maxRows; i++) {
                if (sortedParticipants[i]) {
                    currentIds[i] = sortedParticipants[i].userId;
                    if (currentIds[i] !== lastTop3Ids[i]) {
                        orderChanged = true;
                    }
                } else {
                    currentIds[i] = null;
                    if (lastTop3Ids[i] !== null) {
                        orderChanged = true;
                    }
                }
            }

            // Sonidos de Ranking (Whoosh + Pop)
            if (orderChanged && data.isRunning) {
                const isFirstLoad = lastTop3Ids.every(id => id === null);
                // Validamos si el sonido est치 activado en la configuraci칩n
                if (!isFirstLoad && data.config && data.config.sound !== false) {
                    soundWhoosh.currentTime = 0;
                    soundWhoosh.play().catch(e => {});
                    soundPop.currentTime = 0;
                    soundPop.play().catch(e => console.log("Audio bloqueado"));
                }
            }

            participantsList.innerHTML = ''; 
            const medalNames = ['gold', 'silver', 'bronze'];

            for (let i = 0; i < maxRows; i++) {
                const participant = sortedParticipants[i];
                const isTop3 = i < 3;
                const medalClass = isTop3 ? medalNames[i] : '';
                
                // Icono: Medalla para el Top 3, N칰mero para el 4 en adelante
                const iconHtml = isTop3 
                    ? `<img class="medal-icon" src="${medalImages[medalClass]}">`
                    : `<div class="rank-number">${i + 1}</div>`;

                if (participant) {
                    const row = document.createElement('div');
                    
                    let animClass = '';
                    
                    // --- 1. L칍GICA DE RANKING (Sube/Baja - Tiene prioridad) ---
                    if (data.isRunning && orderChanged) {
                        const prevIndex = lastTop3Ids.indexOf(participant.userId);
                        if (prevIndex === -1 || prevIndex > i) {
                            animClass = 'rank-up'; // Verde y Grande
                        } else if (prevIndex < i) {
                            animClass = 'rank-down'; // Rojo y Peque침o
                        }
                    }

                    // --- 2. L칍GICA DE MONEDAS (Si no cambi칩 de ranking, verificamos monedas) ---
                    if (!animClass && data.isRunning) {
                        // Verificamos si tenemos el dato anterior de este usuario
                        if (lastCoinsMap.hasOwnProperty(participant.userId)) {
                            // Si las monedas actuales son mayores que las anteriores
                            if (participant.coins > lastCoinsMap[participant.userId]) {
                                animClass = 'pulse'; // Solo grande (definido en CSS pulseOnly)
                            }
                        }
                    }

                    // Guardamos monedas actuales para la pr칩xima comparaci칩n
                    lastCoinsMap[participant.userId] = participant.coins;
                    // -------------------------------------------------------------

                    // --- SOLUCI칍N PARA LA FOTO ---
                    // Solo ponemos el style si REALMENTE hay una URL de foto
                    const fotoEstilo = participant.profilePictureUrl ? `style="background-image: url('${participant.profilePictureUrl}')"` : "";
                    const fotoClase = participant.profilePictureUrl ? "" : "default-avatar-icon";

                    row.className = `participant-row ${medalClass} ${animClass}`;
                    row.innerHTML = `${iconHtml}<div class="profile-icon ${fotoClase}" ${fotoEstilo}></div><div class="info-container"><div class="text-bar name">${participant.nickname}</div><div class="bid-container"><span class="coin-icon"></span><span class="text-bar bid">${participant.coins}</span></div></div>`;
                    participantsList.appendChild(row);
                } else {
                    // Placeholder si no hay participantes en ese puesto
                    participantsList.innerHTML += `<div class="participant-row ${medalClass}">${iconHtml}<div class="profile-icon default-avatar-icon"></div><div class="info-container"><div style="height: 12px; width: 150px; border-radius: 6px; background-color: rgba(255, 255, 255, 0.3);"></div><div style="height: 12px; width: 100px; border-radius: 6px; background-color: rgba(255, 255, 255, 0.3);"></div></div></div>`;
                }
            }

            // Actualizar historial de IDs
            lastTop3Ids = currentIds;

            // L칩gica de Ganador 칰nico o Empate en UNA sola tarjeta
            if (data.winners && data.winners.length > 0 && !data.isRunning) {
                const card = document.getElementById('winner-card-single');
                const esEmpate = data.winners.length > 1;
                
                // 1. Generar HTML de las fotos
                let pfpsHTML = '';
                data.winners.forEach(w => {
                    pfpsHTML += `<div class="winner-pfp ${esEmpate ? 'small' : ''}" style="background-image: url('${w.profilePictureUrl || ''}')"></div>`;
                });

                // 2. Generar HTML de los nombres con ancho din치mico
                let namesHTML = '';
                const cantidad = data.winners.length;
                
                // Determinamos qu칠 clase de ancho usar
                let claseAncho = '';
                if (cantidad === 2) claseAncho = 'empate-2';
                if (cantidad === 3) claseAncho = 'empate-3';

                data.winners.forEach(w => {
                    // A침adimos la clase peque침a y la clase de ancho espec칤fico
                    namesHTML += `<span class="winner-name ${esEmpate ? 'small' : ''} ${claseAncho}">${w.nickname}</span>`;
                });

                // 3. Definir Textos e Im치genes
                const textoHeader = esEmpate ? "춰EMPATE!" : "춰GANADOR!";
                const imagenBadge = esEmpate ? "images/empate.png" : "images/top1.png";

                // 4. Inyectar todo en la tarjeta
                card.innerHTML = `
                    <div class="winner-pfps-group">${pfpsHTML}</div>
                    <div class="winner-info">
                        <span class="ganador-text">${textoHeader}</span>
                        <div class="winner-names-group">${namesHTML}</div>
                        <div class="winner-coins">
                            <img src="images/coin-icon.png" class="winner-coin-icon">
                            <span id="winner-coin-amount">${data.winners[0].coins}</span>
                        </div>
                    </div>
                    <img src="${imagenBadge}" class="top1-badge">
                `;

                winnerOverlay.style.display = 'flex';

                if (!winnerOverlay.dataset.celebrated) {
                    // Validamos si el sonido est치 activado para la victoria
                    if (data.config && data.config.sound !== false) {
                        soundWin.currentTime = 0;
                        soundWin.play().catch(e => {});
                    }
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                    winnerOverlay.dataset.celebrated = 'true';
                }
            } else {
                winnerOverlay.style.display = 'none';
                delete winnerOverlay.dataset.celebrated;
            }
        }
    </script>

</body>
</html>