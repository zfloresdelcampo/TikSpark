<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gift VS Gift</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0; padding: 0;
            background-color: transparent; 
            font-family: 'Luckiest Guy', cursive;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .widget-card {
            background-color: #000000;
            border-radius: 20px;
            padding: 30px 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 700px;
            min-height: 400px;
            position: relative;
        }

        #overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            border-radius: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #overlay-img { width: 180px; height: 180px; object-fit: contain; margin-bottom: 10px; }
        #overlay-text { font-size: 80px; color: white; }

        .battle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 200px;
            padding: 10px;
            border-radius: 15px;
        }

        .gift-img { width: 150px; height: 150px; object-fit: contain; }
        .vs-icon { width: 150px; margin: 0 20px; }

        .score {
            font-size: 80px;
            font-weight: 900;
            color: white;
            margin-top: 10px;
            paint-order: stroke fill;
        }

        .status-text {
            margin-top: 20px;
            font-size: 50px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px; /* Restaurado el espaciado original */
            paint-order: stroke fill;
        }

        .with-stroke { -webkit-text-stroke: 1.5px black; }
    </style>
</head>
<body>

    <div class="widget-card" id="main-card">
        
        <div id="overlay-screen">
            <img src="" id="overlay-img" style="display: none;">
            <div id="overlay-text" class="with-stroke">3</div>
        </div>

        <div class="battle-row">
            <div class="team" id="bg-team-left">
                <img src="" class="gift-img" id="img-left">
                <div class="score with-stroke" id="score-left">0</div>
            </div>

            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/70/Street_Fighter_VS_logo.png/600px-Street_Fighter_VS_logo.png" 
                class="vs-icon" id="img-vs">

            <div class="team" id="bg-team-right">
                <img src="" class="gift-img" id="img-right">
                <div class="score with-stroke" id="score-right">0</div>
            </div>
        </div>

        <div class="status-text with-stroke" id="status-text">EMPATE</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const mainCard = document.getElementById('main-card');
        const scoreL = document.getElementById('score-left');
        const scoreR = document.getElementById('score-right');
        const statusText = document.getElementById('status-text');
        const overlay = document.getElementById('overlay-screen');
        const overlayImg = document.getElementById('overlay-img');
        const overlayText = document.getElementById('overlay-text');

        let lastCommandId = null; 
        let startInterval = null; // Variable para controlar el conteo de 3 segundos

        function updateWidget(data) {
            if (!data) return;

            // 1. SIEMPRE ACTUALIZAR NÚMEROS Y COLORES (Base Layer)
            let s1 = parseInt(data.scoreLeft || 0);
            let s2 = parseInt(data.scoreRight || 0);
            scoreL.textContent = s1;
            scoreR.textContent = s2;

            if (data.imgLeft) document.getElementById('img-left').src = data.imgLeft;
            if (data.imgRight) document.getElementById('img-right').src = data.imgRight;

            const s = data.styles || {};
            mainCard.style.backgroundColor = s.bgMain || "#000000";
            document.getElementById('bg-team-left').style.backgroundColor = s.bgGift1 || "transparent";
            document.getElementById('bg-team-right').style.backgroundColor = s.bgGift2 || "transparent";
            if (s.font) document.body.style.fontFamily = s.font;
            if (s.fontSpacing) document.body.style.letterSpacing = s.fontSpacing + 'px';
            else document.body.style.letterSpacing = "";
            const numColor = s.colorNum || "white";
            scoreL.style.color = numColor;
            scoreR.style.color = numColor;
            const bCol = s.colorBorder || "black";
            const stroke = s.borderCheck !== false ? `1.5px ${bCol}` : "0px transparent";
            document.querySelectorAll('.with-stroke').forEach(el => el.style.webkitTextStroke = stroke);

            // Texto de estado inferior (Empate / Gana por X)
            const diff = Math.abs(s2 - s1);
            const labelL = s.textLeft || "en contra :c";
            const labelR = s.textRight || "a favor c:";
            if (s2 > s1) {
                statusText.textContent = `${diff} ${labelR}`;
                statusText.style.color = "#00FF00";
            } else if (s1 > s2) {
                statusText.textContent = `${diff} ${labelL}`;
                statusText.style.color = "#FF0000";
            } else {
                statusText.textContent = "EMPATE";
                statusText.style.color = "white";
            }

            // 2. LÓGICA DE COMANDOS (Capa superior)
            // Si el mensaje no trae comando, nos detenemos aquí.
            if (!data.command || !data.timestamp) return;

            const currentCommandId = data.command + data.timestamp;

            // Si el ID es igual al anterior, es un mensaje repetido, lo ignoramos.
            if (currentCommandId === lastCommandId) return;
            
            lastCommandId = currentCommandId;

            // Si llega un comando nuevo, cancelamos cualquier conteo previo para que no se bugee
            if (startInterval) {
                clearInterval(startInterval);
                startInterval = null;
            }

            if (data.command === 'start') {
                runStartFlow(s.textStart || "Iniciar Batalla");
            } else if (data.command === 'stop') {
                overlay.style.display = 'none'; 
                runStopFlow(s1, s2, s.textWin || "GANA");
            } else if (data.command === 'reset') {
                overlay.style.display = 'none';
            }
        }

        function runStartFlow(txt) {
            overlay.style.display = 'flex';
            overlayImg.style.display = 'none';
            let count = 3;
            overlayText.textContent = count;
            
            startInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    overlayText.textContent = count;
                } else {
                    clearInterval(startInterval);
                    startInterval = null;
                    overlayText.textContent = txt;
                    setTimeout(() => {
                        // Solo ocultamos si no se ha iniciado otro comando entre medias
                        if (!startInterval) overlay.style.display = 'none';
                    }, 1500);
                }
            }, 1000);
        }

        function runStopFlow(s1, s2, txtWin) {
            overlay.style.display = 'flex';
            if (s1 === s2) {
                overlayImg.style.display = 'none';
                overlayText.textContent = "EMPATE";
            } else {
                overlayImg.style.display = 'block';
                overlayImg.src = (s1 > s2) ? document.getElementById('img-left').src : document.getElementById('img-right').src;
                overlayText.textContent = txtWin;
            }

            // --- AGREGA ESTO AQUÍ ABAJO ---
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 3000); // 5000 milisegundos = 5 segundos

        }

        socket.on('init-data', (db) => { if (db && db.giftVsGift1) updateWidget(db.giftVsGift1); });
        socket.on('widget-update', (msg) => { if (msg.widgetId === 'giftVsGift1') updateWidget(msg.data); });
    </script>
</body>
</html>